parameters:
  os : ['ubuntu-latest']
  py_vers: ['3.8']
  test: ['tests/em',
         'tests/base tests/flow tests/seis tests/utils tests/meta',
         'tests/docs -s -v',
         'tests/examples/test_examples_1.py',
         'tests/examples/test_examples_2.py',
         'tests/examples/test_examples_3.py',
         'tests/examples/test_tutorials_1.py tests/examples/test_tutorials_2.py',
         'tests/examples/test_tutorials_3.py',
         'tests/pf',
         'tests/dask', # This must be ran on it's own to avoid modifying the code from any other tests.
         ]

jobs:
  - ${{ each os in parameters.os }}:
    - ${{ each py_vers in parameters.py_vers }}:

      # -----------------------------------------------------------------------
      # Create conda environment
      - job: ${{ replace(os, '-', '_') }}_${{ replace(py_vers, '.', '') }}
        displayName: "Cache conda environment"
        pool:
          vmImage: ${{ os }}
        variables:
          python.version: ${{ py_vers }}
        steps:
          - bash: echo "Trying new job here"

          # Checkout simpeg repo to get the environment file.
          - checkout: self

          - bash: echo "##vso[task.prependpath]$CONDA/bin"
            displayName: Add conda to PATH

          - bash: .ci/azure/setup_env.sh
            displayName: "Setup SimPEG environment"

          - bash: |
              echo "echo $CONDA"
              echo $CONDA
              echo "ls $CONDA"
              ls $CONDA

          - bash : |
              envname=$(grep -e "^name:" .ci/environment_test.yml | cut -f 2 -d ":" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
              echo $envname
              echo "##vso[task.setvariable variable=envname]$envname"
            displayName: "Get name of environment"

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: $CONDA/$(envname)
              artifactName: environment-${{ os }}-${{ py_vers }}
            displayName: "Upload conda environment as artifact"

      # -----------------------------------------------------------------------

      - ${{ each test in parameters.test }}:
        - job:
          displayName: ${{ os }}_${{ py_vers }}_${{ test }}
          dependsOn: ${{ replace(os, '-', '_') }}_${{ replace(py_vers, '.', '') }}
          pool:
            vmImage: ${{ os }}
          timeoutInMinutes: 120
          variables:
            python.version: ${{ py_vers }}
            test.target: ${{ test }}
          steps:

          # Checkout simpeg repo, including tags.
          # We need to sync tags and disable shallow depth in order to get the
          # SimPEG version while building the docs.
          - checkout: self
            fetchDepth: 0
            fetchTags: true
            displayName: Checkout repository (including tags)

          - bash: echo "##vso[task.prependpath]$CONDA/bin"
            displayName: Add conda to PATH

          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: environment-${{ os }}-${{ py_vers }}
              path: $CONDA
            displayName: "Download conda environment artifact"

          - bash : ls -la $CONDA

          - bash: .ci/azure/run_tests_with_coverage.sh
            displayName: 'Testing ${{ test }}'

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: $(Build.SourcesDirectory)/docs/_build/html
              artifactName: html_docs
            displayName: 'Publish documentation artifact'
            condition: eq('${{ test }}', 'tests/docs -s -v')

          - script: |
              curl -Os https://uploader.codecov.io/latest/linux/codecov
              chmod +x codecov
              ./codecov
            displayName: 'Upload coverage to codecov.io'
